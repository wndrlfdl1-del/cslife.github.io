<!DOCTYPE html>
<html lang="ko">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>엑셀 데이터 가공기</title>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            background: white;
            border-radius: 15px;
            box-shadow: 0 20px 40px rgba(0,0,0,0.1);
            overflow: hidden;
        }
        
        .header {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            padding: 30px;
            text-align: center;
        }
        
        .header h1 {
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .content {
            padding: 40px;
        }
        
        .upload-section {
            background: #f8f9fa;
            border: 2px dashed #dee2e6;
            border-radius: 10px;
            padding: 40px;
            text-align: center;
            margin-bottom: 30px;
            transition: all 0.3s ease;
        }
        
        .upload-section:hover {
            border-color: #2196F3;
            background: #e3f2fd;
        }
        
        .file-input {
            display: none;
        }
        
        .upload-btn {
            background: linear-gradient(45deg, #2196F3, #21CBF3);
            color: white;
            border: none;
            padding: 15px 30px;
            border-radius: 25px;
            font-size: 16px;
            cursor: pointer;
            transition: transform 0.3s ease;
        }
        
        .upload-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 5px 15px rgba(33,150,243,0.3);
        }
        
        .controls {
            display: flex;
            gap: 15px;
            margin-bottom: 30px;
            flex-wrap: wrap;
        }
        
        .control-group {
            display: flex;
            flex-direction: column;
            gap: 5px;
        }
        
        .control-group label {
            font-weight: 600;
            color: #333;
        }
        
        .control-group select, 
        .control-group input {
            padding: 10px;
            border: 2px solid #e0e0e0;
            border-radius: 5px;
            font-size: 14px;
        }
        
        .control-group select:focus,
        .control-group input:focus {
            outline: none;
            border-color: #2196F3;
        }
        
        .action-btn {
            background: #4CAF50;
            color: white;
            border: none;
            padding: 12px 25px;
            border-radius: 5px;
            cursor: pointer;
            font-size: 14px;
            transition: background 0.3s ease;
        }
        
        .action-btn:hover {
            background: #45a049;
        }
        
        .data-display {
            background: white;
            border-radius: 10px;
            overflow: hidden;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
        }
        
        .table-container {
            max-height: 500px;
            overflow: auto;
        }
        
        table {
            width: 100%;
            border-collapse: collapse;
        }
        
        th, td {
            padding: 12px;
            text-align: left;
            border-bottom: 1px solid #ddd;
        }
        
        th {
            background: #f5f5f5;
            font-weight: 600;
            position: sticky;
            top: 0;
            z-index: 1;
        }
        
        tr:hover {
            background: #f9f9f9;
        }
        
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        
        .stat-card {
            background: white;
            padding: 20px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0,0,0,0.1);
            text-align: center;
        }
        
        .stat-value {
            font-size: 2em;
            font-weight: bold;
            color: #2196F3;
        }
        
        .stat-label {
            color: #666;
            margin-top: 5px;
        }
        
        .hidden {
            display: none;
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>📊 엑셀 데이터 가공기</h1>
            <p>엑셀 파일을 업로드하고 데이터를 분석해보세요</p>
        </div>
        
        <div class="content">
            <div class="upload-section" id="uploadSection">
                <h3>📁 기준 데이터 파일 업로드 (A열: 증권번호, B열: 사용인코드)</h3>
                <p>첫 번째 파일: 기준이 되는 데이터</p>
                <input type="file" id="fileInput" class="file-input" accept=".xlsx,.xls" />
                <button class="upload-btn" onclick="document.getElementById('fileInput').click()">
                    기준 파일 선택하기
                </button>
            </div>
            
            <div class="upload-section" id="matchUploadSection" style="display: none;">
                <h3>📊 보유계약 데이터 파일 업로드 (A열: 증권번호, E열: 소속, H열: 수금인명)</h3>
                <p>두 번째 파일: 매칭할 보유계약 데이터</p>
                <input type="file" id="matchFileInput" class="file-input" accept=".xlsx,.xls" />
                <button class="upload-btn" onclick="document.getElementById('matchFileInput').click()">
                    매칭 파일 선택하기
                </button>
            </div>
            
            <div id="dataSection" class="hidden">
                <div class="stats" id="statsSection"></div>
                
                <div class="controls">
                    <div class="control-group">
                        <label>시트 선택:</label>
                        <select id="sheetSelect"></select>
                    </div>
                    <div class="control-group">
                        <label>정렬 기준:</label>
                        <select id="sortColumn"></select>
                    </div>
                    <div class="control-group">
                        <label>정렬 방향:</label>
                        <select id="sortOrder">
                            <option value="asc">오름차순</option>
                            <option value="desc">내림차순</option>
                        </select>
                    </div>
                    <div class="control-group">
                        <label>필터:</label>
                        <input type="text" id="filterInput" placeholder="검색어 입력">
                    </div>
                    <button class="action-btn" onclick="applyFilters()">적용</button>
                    <button class="action-btn" onclick="matchData()" id="matchBtn" style="display: none;">데이터 매칭 실행</button>
                    <button class="action-btn" onclick="downloadProcessedData()">가공된 데이터 다운로드</button>
                </div>
                
                <div class="data-display">
                    <div class="table-container">
                        <table id="dataTable">
                            <thead id="tableHead"></thead>
                            <tbody id="tableBody"></tbody>
                        </table>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <script>
        let workbook = null;
        let matchWorkbook = null;
        let currentData = [];
        let matchFileData = [];
        let originalData = [];
        let currentSheet = '';
        let matchedData = [];

        // 파일 업로드 처리
        document.getElementById('fileInput').addEventListener('change', handleFile);
        document.getElementById('matchFileInput').addEventListener('change', handleMatchFile);
        
        // 드래그 앤 드롭 처리
        const uploadSection = document.getElementById('uploadSection');
        uploadSection.addEventListener('dragover', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#2196F3';
            uploadSection.style.background = '#e3f2fd';
        });
        
        uploadSection.addEventListener('dragleave', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#dee2e6';
            uploadSection.style.background = '#f8f9fa';
        });
        
        uploadSection.addEventListener('drop', (e) => {
            e.preventDefault();
            uploadSection.style.borderColor = '#dee2e6';
            uploadSection.style.background = '#f8f9fa';
            
            const files = e.dataTransfer.files;
            if (files.length > 0) {
                processFile(files[0]);
            }
        });

        function handleFile(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file, 'base');
            }
        }

        function handleMatchFile(e) {
            const file = e.target.files[0];
            if (file) {
                processFile(file, 'match');
            }
        }

        function processFile(file, type) {
            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    if (type === 'base') {
                        workbook = XLSX.read(e.target.result, {type: 'binary'});
                        setupSheetSelector();
                        loadSheet(workbook.SheetNames[0]);
                        document.getElementById('dataSection').classList.remove('hidden');
                        document.getElementById('matchUploadSection').style.display = 'block';
                    } else if (type === 'match') {
                        matchWorkbook = XLSX.read(e.target.result, {type: 'binary'});
                        loadMatchData();
                        document.getElementById('matchBtn').style.display = 'inline-block';
                    }
                } catch (error) {
                    alert('파일을 읽는 중 오류가 발생했습니다: ' + error.message);
                }
            };
            reader.readAsBinaryString(file);
        }

        function setupSheetSelector() {
            const sheetSelect = document.getElementById('sheetSelect');
            sheetSelect.innerHTML = '';
            
            workbook.SheetNames.forEach(name => {
                const option = document.createElement('option');
                option.value = name;
                option.textContent = name;
                sheetSelect.appendChild(option);
            });
            
            sheetSelect.addEventListener('change', (e) => {
                loadSheet(e.target.value);
            });
        }

        function loadSheet(sheetName) {
            currentSheet = sheetName;
            const worksheet = workbook.Sheets[sheetName];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            if (jsonData.length === 0) {
                alert('선택한 시트에 데이터가 없습니다.');
                return;
            }
            
            // 헤더와 데이터 분리
            const headers = jsonData[0];
            const rows = jsonData.slice(1);
            
            // 객체 배열로 변환
            originalData = rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index] || '';
                });
                return obj;
            });
            
            currentData = [...originalData];
            
            setupColumnSelector(headers);
            displayData();
            showStats();
        }

        function setupColumnSelector(headers) {
            const sortColumn = document.getElementById('sortColumn');
            sortColumn.innerHTML = '<option value="">선택하세요</option>';
            
            headers.forEach(header => {
                const option = document.createElement('option');
                option.value = header;
                option.textContent = header;
                sortColumn.appendChild(option);
            });
        }

        function displayData() {
            const tableHead = document.getElementById('tableHead');
            const tableBody = document.getElementById('tableBody');
            
            if (currentData.length === 0) {
                tableHead.innerHTML = '';
                tableBody.innerHTML = '<tr><td colspan="100%">데이터가 없습니다.</td></tr>';
                return;
            }
            
            // 헤더 생성
            const headers = Object.keys(currentData[0]);
            tableHead.innerHTML = '<tr>' + headers.map(h => `<th>${h}</th>`).join('') + '</tr>';
            
            // 데이터 행 생성
            tableBody.innerHTML = currentData.map(row => 
                '<tr>' + headers.map(h => `<td>${row[h]}</td>`).join('') + '</tr>'
            ).join('');
        }

        function showStats() {
            const statsSection = document.getElementById('statsSection');
            
            const totalRows = currentData.length;
            const totalColumns = currentData.length > 0 ? Object.keys(currentData[0]).length : 0;
            
            // 숫자 컬럼들의 합계/평균 계산
            const numericStats = calculateNumericStats();
            
            let statsHTML = `
                <div class="stat-card">
                    <div class="stat-value">${totalRows.toLocaleString()}</div>
                    <div class="stat-label">총 행 수</div>
                </div>
                <div class="stat-card">
                    <div class="stat-value">${totalColumns}</div>
                    <div class="stat-label">총 열 수</div>
                </div>
            `;
            
            numericStats.forEach(stat => {
                statsHTML += `
                    <div class="stat-card">
                        <div class="stat-value">${stat.value}</div>
                        <div class="stat-label">${stat.label}</div>
                    </div>
                `;
            });
            
            statsSection.innerHTML = statsHTML;
        }

        function calculateNumericStats() {
            if (currentData.length === 0) return [];
            
            const stats = [];
            const headers = Object.keys(currentData[0]);
            
            headers.forEach(header => {
                const values = currentData.map(row => parseFloat(row[header])).filter(v => !isNaN(v));
                if (values.length > 0) {
                    const sum = values.reduce((a, b) => a + b, 0);
                    const avg = sum / values.length;
                    stats.push({
                        value: avg.toLocaleString(undefined, {maximumFractionDigits: 2}),
                        label: `${header} 평균`
                    });
                }
            });
            
            return stats.slice(0, 4); // 최대 4개까지만 표시
        }

        function applyFilters() {
            let filteredData = [...originalData];
            
            // 필터 적용
            const filterText = document.getElementById('filterInput').value.toLowerCase();
            if (filterText) {
                filteredData = filteredData.filter(row => 
                    Object.values(row).some(value => 
                        String(value).toLowerCase().includes(filterText)
                    )
                );
            }
            
            // 정렬 적용
            const sortColumn = document.getElementById('sortColumn').value;
            const sortOrder = document.getElementById('sortOrder').value;
            
            if (sortColumn) {
                filteredData.sort((a, b) => {
                    let aVal = a[sortColumn];
                    let bVal = b[sortColumn];
                    
                    // 숫자인지 확인
                    const aNum = parseFloat(aVal);
                    const bNum = parseFloat(bVal);
                    
                    if (!isNaN(aNum) && !isNaN(bNum)) {
                        return sortOrder === 'asc' ? aNum - bNum : bNum - aNum;
                    } else {
                        aVal = String(aVal).toLowerCase();
                        bVal = String(bVal).toLowerCase();
                        if (sortOrder === 'asc') {
                            return aVal < bVal ? -1 : aVal > bVal ? 1 : 0;
                        } else {
                            return aVal > bVal ? -1 : aVal < bVal ? 1 : 0;
                        }
                    }
                });
            }
            
            currentData = filteredData;
            displayData();
            showStats();
        }

        function downloadProcessedData() {
            if (currentData.length === 0) {
                alert('다운로드할 데이터가 없습니다.');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(currentData);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "가공된데이터");
            
            const fileName = `가공된데이터_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }

        function loadMatchData() {
            const worksheet = matchWorkbook.Sheets[matchWorkbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            if (jsonData.length === 0) {
                alert('매칭 파일에 데이터가 없습니다.');
                return;
            }
            
            const headers = jsonData[0];
            const rows = jsonData.slice(1);
            
            matchFileData = rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index] || '';
                });
                return obj;
            });
            
            alert(`매칭 데이터 ${matchFileData.length}건이 로드되었습니다.`);
        }

        function matchData() {
            if (!workbook || !matchWorkbook) {
                alert('두 파일을 모두 업로드해주세요.');
                return;
            }
            
            if (originalData.length === 0 || matchFileData.length === 0) {
                alert('데이터가 없습니다.');
                return;
            }
            
            // 매칭 데이터를 증권번호로 인덱싱
            const matchIndex = {};
            matchFileData.forEach(row => {
                const headers = Object.keys(row);
                const securityNumber = row[headers[0]]; // A열 (증권번호)
                if (securityNumber) {
                    matchIndex[securityNumber] = {
                        소속: row[headers[4]] || '', // E열 (소속)
                        수금인명: row[headers[7]] || '' // H열 (수금인명)
                    };
                }
            });
            
            // 기준 데이터에 매칭 정보 추가
            matchedData = originalData.map(row => {
                const headers = Object.keys(row);
                const securityNumber = row[headers[0]]; // A열 (증권번호)
                const matchInfo = matchIndex[securityNumber];
                
                return {
                    ...row,
                    '매칭_소속': matchInfo ? matchInfo.소속 : '매칭안됨',
                    '매칭_수금인명': matchInfo ? matchInfo.수금인명 : '매칭안됨'
                };
            });
            
            // 매칭된 건수 계산
            const matchedCount = matchedData.filter(row => 
                row['매칭_소속'] !== '매칭안됨' && row['매칭_수금인명'] !== '매칭안됨'
            ).length;
            
            alert(`매칭 완료: 총 ${originalData.length}건 중 ${matchedCount}건 매칭되었습니다.`);
            
            // 매칭된 데이터를 현재 데이터로 설정
            currentData = [...matchedData];
            displayData();
            showStats();
        }

        function loadMatchData() {
            const worksheet = matchWorkbook.Sheets[matchWorkbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(worksheet, {header: 1});
            
            if (jsonData.length === 0) {
                alert('매칭 파일에 데이터가 없습니다.');
                return;
            }
            
            const headers = jsonData[0];
            const rows = jsonData.slice(1);
            
            matchData = rows.map(row => {
                const obj = {};
                headers.forEach((header, index) => {
                    obj[header] = row[index] || '';
                });
                return obj;
            });
            
            alert(`매칭 데이터 ${matchData.length}건이 로드되었습니다.`);
        }

        function matchData() {
            if (!workbook || !matchWorkbook) {
                alert('두 파일을 모두 업로드해주세요.');
                return;
            }
            
            if (originalData.length === 0 || matchData.length === 0) {
                alert('데이터가 없습니다.');
                return;
            }
            
            // 매칭 데이터를 증권번호로 인덱싱
            const matchIndex = {};
            matchData.forEach(row => {
                const headers = Object.keys(row);
                const securityNumber = row[headers[0]]; // A열 (증권번호)
                if (securityNumber) {
                    matchIndex[securityNumber] = {
                        소속: row[headers[4]] || '', // E열 (소속)
                        수금인명: row[headers[7]] || '' // H열 (수금인명)
                    };
                }
            });
            
            // 기준 데이터에 매칭 정보 추가
            matchedData = originalData.map(row => {
                const headers = Object.keys(row);
                const securityNumber = row[headers[0]]; // A열 (증권번호)
                const matchInfo = matchIndex[securityNumber];
                
                return {
                    ...row,
                    '매칭_소속': matchInfo ? matchInfo.소속 : '매칭안됨',
                    '매칭_수금인명': matchInfo ? matchInfo.수금인명 : '매칭안됨'
                };
            });
            
            // 매칭된 건수 계산
            const matchedCount = matchedData.filter(row => 
                row['매칭_소속'] !== '매칭안됨' && row['매칭_수금인명'] !== '매칭안됨'
            ).length;
            
            alert(`매칭 완료: 총 ${originalData.length}건 중 ${matchedCount}건 매칭되었습니다.`);
            
            // 매칭된 데이터를 현재 데이터로 설정
            currentData = [...matchedData];
            displayData();
            showStats();
        }

        function downloadProcessedData() {
            let dataToDownload = currentData;
            
            // 매칭된 데이터가 있으면 그것을 사용
            if (matchedData.length > 0) {
                dataToDownload = matchedData;
            }
            
            if (dataToDownload.length === 0) {
                alert('다운로드할 데이터가 없습니다.');
                return;
            }
            
            const ws = XLSX.utils.json_to_sheet(dataToDownload);
            const wb = XLSX.utils.book_new();
            XLSX.utils.book_append_sheet(wb, ws, "가공된데이터");
            
            const fileName = `가공된데이터_${new Date().toISOString().slice(0,10)}.xlsx`;
            XLSX.writeFile(wb, fileName);
        }
    </script>
</body>
</html>
